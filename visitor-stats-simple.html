<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistik Pengunjung - Lestari Akuatik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-bar {
            transition: height 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-blue-900 text-white py-4">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
                            <path d="M2 6c.6.2 1.4.5 2.5 1.4C6.5 9 8.6 10.5 10 10.5c1.4 0 2.5-.5 4-1.5 1.5-.9 3.2-1.5 5.5-1.5s4.2 1.5 5.5 2.5"/>
                            <path d="M2 12c.6.2 1.4.5 2.5 1.4C6.5 15 8.6 16.5 10 16.5c1.4 0 2.5-.5 4-1.5 1.5-.9 3.2-1.5 5.5-1.5s4.2 1.5 5.5 2.5"/>
                            <path d="M2 18c.6.2 1.4.5 2.5 1.4C6.5 21 8.6 22.5 10 22.5c1.4 0 2.5-.5 4-1.5 1.5-.9 3.2-1.5 5.5-1.5s4.2 1.5 5.5 2.5"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Lestari Akuatik</h1>
                        <p class="text-sm text-blue-200">Statistik Pengunjung</p>
                    </div>
                </div>
                <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    ‚Üê Kembali
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- Page Header -->
            <div class="text-center mb-8 fade-in">
                <h1 class="text-4xl font-bold text-white mb-4">Statistik Pengunjung</h1>
                <p class="text-gray-300 text-lg">Data kunjungan dan analisis pengunjung website Lestari Akuatik</p>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                <p class="mt-4 text-gray-300">Memuat data statistik...</p>
            </div>

            <!-- Stats Content -->
            <div id="stats-content" class="hidden">
                <!-- Current Session Info -->
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg p-6 mb-8 fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-2">Sesi Saat Ini</h2>
                            <p class="text-blue-100" id="current-session-duration">Menghitung durasi...</p>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-white" id="current-visitor-count">0</div>
                            <div class="text-blue-100">Total Kunjungan</div>
                        </div>
                    </div>
                </div>

                <!-- Daily Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-green-600 rounded-lg p-6 fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-1">Hari Ini</h3>
                                <p class="text-green-100 text-sm">Kunjungan</p>
                            </div>
                            <div class="text-3xl font-bold text-white" id="today-visits">0</div>
                        </div>
                        <div class="mt-4">
                            <p class="text-green-100 text-sm">Pengunjung Unik: <span id="today-unique" class="font-semibold">0</span></p>
                            <p class="text-green-100 text-sm">Durasi Rata-rata: <span id="today-duration" class="font-semibold">0 detik</span></p>
                        </div>
                    </div>

                    <div class="bg-blue-600 rounded-lg p-6 fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-1">Kemarin</h3>
                                <p class="text-blue-100 text-sm">Kunjungan</p>
                            </div>
                            <div class="text-3xl font-bold text-white" id="yesterday-visits">0</div>
                        </div>
                        <div class="mt-4">
                            <p class="text-blue-100 text-sm">Pengunjung Unik: <span id="yesterday-unique" class="font-semibold">0</span></p>
                            <p class="text-blue-100 text-sm">Durasi Rata-rata: <span id="yesterday-duration" class="font-semibold">0 detik</span></p>
                        </div>
                    </div>

                    <div class="bg-purple-600 rounded-lg p-6 fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-1">Total</h3>
                                <p class="text-purple-100 text-sm">Kunjungan</p>
                            </div>
                            <div class="text-3xl font-bold text-white" id="total-visits">0</div>
                        </div>
                        <div class="mt-4">
                            <p class="text-purple-100 text-sm">Pengunjung Unik: <span id="total-unique" class="font-semibold">0</span></p>
                            <p class="text-purple-100 text-sm">Rata-rata Durasi: <span id="total-duration" class="font-semibold">0 detik</span></p>
                        </div>
                    </div>
                </div>

                <!-- 7 Days Chart -->
                <div class="bg-gray-800 rounded-lg p-6 mb-8 fade-in">
                    <h3 class="text-xl font-bold text-white mb-6">7 Hari Terakhir</h3>
                    <div class="grid grid-cols-7 gap-2">
                        <div id="chart-container" class="col-span-7">
                            <!-- Chart will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Detailed Statistics -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- All Time Stats -->
                    <div class="bg-gray-800 rounded-lg p-6 fade-in">
                        <h3 class="text-xl font-bold text-white mb-4">Statistik Keseluruhan</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Total Kunjungan</span>
                                <span class="text-white font-semibold text-lg" id="all-time-visits">0</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Pengunjung Unik</span>
                                <span class="text-white font-semibold text-lg" id="all-time-unique">0</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Total Sesi</span>
                                <span class="text-white font-semibold text-lg" id="all-time-sessions">0</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-300">Rata-rata Durasi</span>
                                <span class="text-white font-semibold text-lg" id="all-time-avg-duration">0 detik</span>
                            </div>
                        </div>
                    </div>

                    <!-- Session Info -->
                    <div class="bg-gray-800 rounded-lg p-6 fade-in">
                        <h3 class="text-xl font-bold text-white mb-4">Informasi Sesi</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Kunjungan Terakhir</span>
                                <span class="text-white font-semibold text-sm" id="last-visit">Tidak ada</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Pengunjung Unik Hari Ini</span>
                                <span class="text-white font-semibold text-lg" id="today-unique-count">0</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Status Sesi</span>
                                <span class="text-green-400 font-semibold" id="session-status">Aktif</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-300">Durasi Sesi Saat Ini</span>
                                <span class="text-white font-semibold text-lg" id="current-session-time">0 detik</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center fade-in">
                    <button onclick="refreshStats()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg mr-4 transition-colors">
                        üîÑ Perbarui Data
                    </button>
                    <button onclick="goBack()" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                        ‚Üê Kembali
                    </button>
                </div>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden text-center py-12">
                <div class="text-red-400 text-6xl mb-4">‚ö†Ô∏è</div>
                <h2 class="text-2xl font-bold text-white mb-2">Gagal Memuat Data</h2>
                <p class="text-gray-300 mb-6">Terjadi kesalahan saat memuat statistik pengunjung.</p>
                <button onclick="refreshStats()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    Coba Lagi
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-6 mt-8">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2024 Lestari Akuatik - BKHIT Sulawesi Utara</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="visitor-counter.js"></script>
    <script>
        // Format duration function
        function formatDuration(seconds) {
            if (seconds < 60) {
                return `${seconds} detik`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}m ${remainingSeconds}s`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}j ${minutes}m`;
            }
        }

        // Update current session duration
        function updateCurrentSession() {
            if (window.visitorCounter) {
                try {
                    const duration = Math.round(window.visitorCounter.getSessionDuration() / 1000);
                    const currentSessionDuration = document.getElementById('current-session-duration');
                    const currentSessionTime = document.getElementById('current-session-time');
                    
                    if (currentSessionDuration) {
                        currentSessionDuration.textContent = `Durasi: ${formatDuration(duration)}`;
                    }
                    if (currentSessionTime) {
                        currentSessionTime.textContent = formatDuration(duration);
                    }
                } catch (error) {
                    console.error('Error updating session duration:', error);
                }
            }
        }

        // Load and display statistics
        function loadStats() {
            try {
                if (!window.visitorCounter) {
                    throw new Error('Visitor counter not available');
                }

                const stats = window.visitorCounter.getStats();
                const dailyStats = stats.dailyStats || {};

                // Update current session info
                const currentVisitorCount = document.getElementById('current-visitor-count');
                if (currentVisitorCount) {
                    currentVisitorCount.textContent = (stats.totalVisits || 0).toLocaleString('id-ID');
                }
                updateCurrentSession();

                // Update daily stats with safe access
                const todayVisits = document.getElementById('today-visits');
                if (todayVisits) {
                    todayVisits.textContent = dailyStats.today?.visits || 0;
                }

                const todayUnique = document.getElementById('today-unique');
                if (todayUnique) {
                    todayUnique.textContent = dailyStats.today?.uniqueVisitors || 0;
                }

                const todayDuration = document.getElementById('today-duration');
                if (todayDuration) {
                    todayDuration.textContent = formatDuration(dailyStats.today?.avgDuration || 0);
                }

                const yesterdayVisits = document.getElementById('yesterday-visits');
                if (yesterdayVisits) {
                    yesterdayVisits.textContent = dailyStats.yesterday?.visits || 0;
                }

                const yesterdayUnique = document.getElementById('yesterday-unique');
                if (yesterdayUnique) {
                    yesterdayUnique.textContent = dailyStats.yesterday?.uniqueVisitors || 0;
                }

                const yesterdayDuration = document.getElementById('yesterday-duration');
                if (yesterdayDuration) {
                    yesterdayDuration.textContent = formatDuration(dailyStats.yesterday?.avgDuration || 0);
                }

                const totalVisits = document.getElementById('total-visits');
                if (totalVisits) {
                    totalVisits.textContent = (stats.totalVisits || 0).toLocaleString('id-ID');
                }

                const totalUnique = document.getElementById('total-unique');
                if (totalUnique) {
                    totalUnique.textContent = (stats.uniqueVisitors || 0).toLocaleString('id-ID');
                }

                const totalDuration = document.getElementById('total-duration');
                if (totalDuration) {
                    totalDuration.textContent = formatDuration(dailyStats.allTime?.avgDuration || 0);
                }

                // Update all time stats
                const allTimeVisits = document.getElementById('all-time-visits');
                if (allTimeVisits) {
                    allTimeVisits.textContent = (dailyStats.allTime?.totalVisits || 0).toLocaleString('id-ID');
                }

                const allTimeUnique = document.getElementById('all-time-unique');
                if (allTimeUnique) {
                    allTimeUnique.textContent = (dailyStats.allTime?.totalUniqueVisitors || 0).toLocaleString('id-ID');
                }

                const allTimeSessions = document.getElementById('all-time-sessions');
                if (allTimeSessions) {
                    allTimeSessions.textContent = (dailyStats.allTime?.totalSessions || 0).toLocaleString('id-ID');
                }

                const allTimeAvgDuration = document.getElementById('all-time-avg-duration');
                if (allTimeAvgDuration) {
                    allTimeAvgDuration.textContent = formatDuration(dailyStats.allTime?.avgDuration || 0);
                }

                // Update session info
                const lastVisit = document.getElementById('last-visit');
                if (lastVisit) {
                    lastVisit.textContent = stats.lastVisit ? 
                        new Date(stats.lastVisit).toLocaleString('id-ID') : 'Tidak ada';
                }

                const todayUniqueCount = document.getElementById('today-unique-count');
                if (todayUniqueCount) {
                    todayUniqueCount.textContent = dailyStats.today?.uniqueVisitors || 0;
                }

                const sessionStatus = document.getElementById('session-status');
                if (sessionStatus) {
                    sessionStatus.textContent = 'Aktif';
                }

                // Generate 7 days chart
                if (dailyStats.last7Days && Array.isArray(dailyStats.last7Days)) {
                    generateChart(dailyStats.last7Days);
                }

                // Hide loading, show content
                const loadingState = document.getElementById('loading-state');
                const statsContent = document.getElementById('stats-content');
                if (loadingState) loadingState.classList.add('hidden');
                if (statsContent) statsContent.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading stats:', error);
                const loadingState = document.getElementById('loading-state');
                const errorState = document.getElementById('error-state');
                if (loadingState) loadingState.classList.add('hidden');
                if (errorState) errorState.classList.remove('hidden');
            }
        }

        // Generate 7 days chart
        function generateChart(last7Days) {
            try {
                const container = document.getElementById('chart-container');
                if (!container || !Array.isArray(last7Days) || last7Days.length === 0) {
                    return;
                }

                const maxVisits = Math.max(...last7Days.map(day => day.visits || 0), 1);
                
                const chartHTML = last7Days.map(day => {
                    const visits = day.visits || 0;
                    const height = Math.max(20, (visits / maxVisits) * 120);
                    const date = new Date(day.date);
                    const dayName = date.toLocaleDateString('id-ID', { weekday: 'short' });
                    const dayNumber = date.getDate();
                    const avgDuration = day.avgDuration || 0;
                    
                    return `
                        <div class="text-center">
                            <div class="text-xs text-gray-400 mb-2">${dayName}</div>
                            <div class="text-xs text-gray-500 mb-1">${dayNumber}</div>
                            <div class="bg-blue-500 chart-bar rounded-t flex items-end justify-center relative group" 
                                 style="height: ${height}px; min-height: 20px;">
                                <span class="text-xs font-semibold text-white absolute -top-6 opacity-0 group-hover:opacity-100 transition-opacity">
                                    ${visits}
                                </span>
                            </div>
                            <div class="text-xs text-gray-400 mt-2">${formatDuration(avgDuration)}</div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = chartHTML;
            } catch (error) {
                console.error('Error generating chart:', error);
                const container = document.getElementById('chart-container');
                if (container) {
                    container.innerHTML = '<div class="text-center text-gray-400">Grafik tidak dapat dimuat</div>';
                }
            }
        }

        // Refresh stats
        function refreshStats() {
            try {
                const loadingState = document.getElementById('loading-state');
                const statsContent = document.getElementById('stats-content');
                const errorState = document.getElementById('error-state');
                
                if (loadingState) loadingState.classList.remove('hidden');
                if (statsContent) statsContent.classList.add('hidden');
                if (errorState) errorState.classList.add('hidden');
                
                setTimeout(() => {
                    loadStats();
                }, 500);
            } catch (error) {
                console.error('Error refreshing stats:', error);
            }
        }

        // Go back function
        function goBack() {
            try {
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Error going back:', error);
                window.location.href = 'index.html';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            try {
                let checkCounter;
                let sessionUpdateInterval;
                
                // Wait for visitor counter to be ready
                checkCounter = setInterval(() => {
                    if (window.visitorCounter) {
                        clearInterval(checkCounter);
                        loadStats();
                    }
                }, 100);

                // Update current session every second
                sessionUpdateInterval = setInterval(updateCurrentSession, 1000);

                // Timeout after 5 seconds
                setTimeout(() => {
                    const loadingState = document.getElementById('loading-state');
                    if (loadingState && !loadingState.classList.contains('hidden')) {
                        clearInterval(checkCounter);
                        loadingState.classList.add('hidden');
                        const errorState = document.getElementById('error-state');
                        if (errorState) {
                            errorState.classList.remove('hidden');
                        }
                    }
                }, 5000);

                // Cleanup on page unload
                window.addEventListener('beforeunload', function() {
                    if (checkCounter) clearInterval(checkCounter);
                    if (sessionUpdateInterval) clearInterval(sessionUpdateInterval);
                });

            } catch (error) {
                console.error('Error initializing page:', error);
                const loadingState = document.getElementById('loading-state');
                const errorState = document.getElementById('error-state');
                if (loadingState) loadingState.classList.add('hidden');
                if (errorState) errorState.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
